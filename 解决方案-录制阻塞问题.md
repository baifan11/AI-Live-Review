# 录制任务阻塞问题 - 解决方案

## 问题描述

你遇到的问题：**测试时打开 Chrome 等待反馈，对话停止并无法继续**

## 根本原因

虽然你的项目没有使用 Chrome 浏览器自动化，但问题的根本原因是：

### 1. **长时间运行的异步任务阻塞**
- FFmpeg 录制是一个长时间运行的进程
- 如果录制时长设置较长（如 60 秒、300 秒），会导致异步任务长时间挂起
- 这会让 API 请求超时，导致对话中断

### 2. **网络请求无超时控制**
- 获取直播流 URL 的网络请求没有超时限制
- 如果网络不稳定或直播平台响应慢，会无限期等待

### 3. **缺少详细的进度日志**
- 无法知道任务卡在哪一步
- 难以诊断具体问题

---

## 已实施的解决方案

我已经对以下文件进行了改进：

### ✅ 1. `server/services/recorder.py` - 添加录制超时控制

**改进内容：**
- 为 FFmpeg 录制添加超时机制：`录制时长 + 30秒缓冲`
- 改进错误处理和进程终止逻辑
- 添加详细的日志记录

**关键代码：**
```python
# 添加超时控制
timeout = duration + 30
stdout, stderr = await asyncio.wait_for(
    process.communicate(),
    timeout=timeout
)
```

**效果：**
- ✅ 防止 FFmpeg 进程无限期阻塞
- ✅ 超时后自动终止进程
- ✅ 提供清晰的错误信息

---

### ✅ 2. `server/services/stream_fetcher.py` - 添加网络请求超时

**改进内容：**
- 为所有直播平台的 API 请求添加 30 秒超时
- 为流 URL 解析添加 10 秒超时
- 统一的超时错误处理

**关键代码：**
```python
# 为网络请求添加超时
json_data = await asyncio.wait_for(
    spider.get_douyin_web_stream_data(url, proxy_addr=proxy, cookies=cookies),
    timeout=30
)
```

**效果：**
- ✅ 防止网络请求长时间挂起
- ✅ 快速失败，提供明确的错误信息
- ✅ 提高系统响应性

---

### ✅ 3. `server/scheduler.py` - 增强日志记录

**改进内容：**
- 添加详细的步骤日志（Step 1/5, Step 2/5...）
- 记录每个关键操作的开始和完成
- 使用醒目的分隔符标记任务开始/结束
- 添加异常堆栈跟踪

**关键改进：**
```python
logger.info(f"[Task {task_id}] Step 1/5: Fetching stream URL")
logger.info(f"[Task {task_id}] Step 2/5: Starting recording (duration: {task.duration}s)")
logger.info(f"========== Task {task_id} completed successfully ==========")
```

**效果：**
- ✅ 清晰了解任务执行进度
- ✅ 快速定位问题所在步骤
- ✅ 便于调试和监控

---

## 测试步骤

### 方法 1: 使用测试脚本（推荐）

我创建了一个快速测试脚本 `test_recording.py`，可以独立测试录制功能：

```bash
cd /Users/baifan/Desktop/develop/AI-review
source server/venv/bin/activate
python test_recording.py
```

**这个脚本会：**
1. 测试获取直播流 URL（30秒超时）
2. 测试录制功能（10秒录制）
3. 显示详细的执行日志
4. 验证文件是否成功创建

---

### 方法 2: 通过 API 测试

#### 步骤 1: 确保服务正在运行

检查你的终端，应该看到：
- ✅ `uvicorn server.main:app --reload --port 8000` 正在运行
- ✅ `npm run dev` 正在运行（前端）

#### 步骤 2: 创建测试任务

**重要：先使用短时长测试（10-30秒）**

在前端界面或使用 curl 创建任务：

```bash
curl -X POST http://localhost:8000/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试任务-短时长",
    "url": "https://live.douyin.com/745964462470",
    "duration": 10,
    "interval": 300,
    "ai_enabled": false,
    "audio_only": false,
    "is_active": true
  }'
```

#### 步骤 3: 观察日志

在运行 uvicorn 的终端中，你应该看到类似的日志：

```
INFO: ========== Starting recording job for task 1 ==========
INFO: Created record 1 for task 1
INFO: [Task 1] Step 1/5: Fetching stream URL for https://live.douyin.com/...
INFO: Fetching stream URL with timeout: 30s
INFO: [Task 1] Stream URL obtained: https://...
INFO: [Task 1] Step 2/5: Starting recording (duration: 10s)
INFO: Recording to storage/1/20251120_173000.mp4
INFO: Recording with timeout: 40s
INFO: Recording completed successfully: storage/1/20251120_173000.mp4
INFO: [Task 1] Recording completed successfully
INFO: ========== Task 1 completed successfully ==========
```

#### 步骤 4: 验证结果

检查以下内容：

1. **文件是否创建：**
```bash
ls -lh storage/1/
```

2. **数据库记录：**
```bash
sqlite3 database.db "SELECT id, task_id, status, video_path FROM records ORDER BY created_at DESC LIMIT 5;"
```

3. **任务状态：**
访问 http://localhost:5173/ 查看任务列表

---

## 常见问题排查

### ❌ 问题 1: 任务一直显示 "recording" 状态

**可能原因：**
- 直播间不在线
- 网络连接问题
- FFmpeg 未正确安装

**排查步骤：**
1. 检查日志，看卡在哪一步
2. 手动访问直播间 URL，确认是否在线
3. 运行测试脚本验证

---

### ❌ 问题 2: 超时错误 "timeout after 30s"

**可能原因：**
- 网络速度慢
- 直播平台 API 响应慢
- 需要 Cookie 认证

**解决方法：**
1. 增加超时时间（修改 `stream_fetcher.py` 中的 `timeout=30` 为更大的值）
2. 检查网络连接
3. 配置相应平台的 Cookie（在 `.env` 文件中）

---

### ❌ 问题 3: FFmpeg 错误

**可能原因：**
- FFmpeg 未安装或版本不兼容
- 流媒体格式不支持

**解决方法：**
```bash
# 检查 FFmpeg 是否安装
ffmpeg -version

# 如果未安装，使用项目提供的安装脚本
python ffmpeg_install.py
```

---

### ❌ 问题 4: 对话仍然中断

**如果改进后问题仍然存在，可能是：**

1. **录制时长过长**
   - 解决：使用较短的 duration（建议 ≤ 60 秒）
   - 或者考虑将录制改为完全后台任务

2. **前端请求超时**
   - 检查前端是否有 HTTP 请求超时设置
   - 考虑使用 WebSocket 推送进度更新

3. **AI 处理时间过长**
   - 先关闭 AI 功能测试（`ai_enabled: false`）
   - 确认是录制还是 AI 处理导致的阻塞

---

## 进一步优化建议

如果基本功能正常，但仍需要改进，可以考虑：

### 🚀 优化 1: 使用任务队列

使用 Celery 或 RQ 将录制任务完全放到独立的工作进程：

```python
# 使用 Celery
@celery.app.task
def recording_task(task_id):
    # 录制逻辑
    pass
```

### 🚀 优化 2: WebSocket 进度推送

让前端通过 WebSocket 实时接收任务进度：

```python
# FastAPI WebSocket
@app.websocket("/ws/task/{task_id}")
async def task_progress(websocket: WebSocket, task_id: int):
    await websocket.accept()
    # 推送进度更新
```

### 🚀 优化 3: 分离录制和分析

- 录制完成后立即返回
- AI 分析作为独立的后台任务

---

## 下一步行动

### 1️⃣ 立即测试

运行测试脚本验证改进：
```bash
cd /Users/baifan/Desktop/develop/AI-review
source server/venv/bin/activate
python test_recording.py
```

### 2️⃣ 创建短时长任务

通过前端或 API 创建一个 10 秒的测试任务

### 3️⃣ 观察日志

密切关注终端日志，看是否有：
- ✅ 清晰的步骤日志
- ✅ 超时控制生效
- ✅ 任务成功完成

### 4️⃣ 反馈结果

如果仍有问题，请提供：
- 📋 完整的错误日志
- ⚙️ 任务配置（duration, url 等）
- 📍 卡住的具体步骤

---

## 总结

### ✅ 已解决的问题

1. ✅ FFmpeg 录制无超时控制 → **添加了超时机制**
2. ✅ 网络请求可能长时间挂起 → **添加了 30 秒超时**
3. ✅ 缺少详细日志 → **添加了步骤化日志**
4. ✅ 错误处理不完善 → **改进了异常处理**

### 🎯 预期效果

- 任务不会无限期阻塞
- 超时后会快速失败并提供错误信息
- 可以清晰看到任务执行到哪一步
- 系统响应更快，不会导致对话中断

### 📞 需要帮助？

如果测试后仍有问题，请告诉我：
1. 测试脚本的输出结果
2. 具体的错误信息
3. 任务卡在哪个步骤

我会继续帮你优化！
