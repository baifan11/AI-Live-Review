# 功能升级总结

## ✅ 已完成的升级

### 1. 录制段数控制功能

#### 后端实现
- **数据库模型** (`server/database.py`)
  - 在 `TaskBase` 中添加了 `max_recordings` 字段（默认值为 0，表示无限制）
  
- **调度逻辑** (`server/scheduler.py`)
  - 在每次录制完成后，检查已完成的录制数量
  - 如果达到 `max_recordings` 设定值，自动停止任务：
    - 将 `task.is_active` 设为 `False`
    - 从调度器中移除该任务
    - 记录日志
  - 只统计状态为 `recorded` 或 `analyzed` 的记录

#### 前端实现
- **API 类型定义** (`web/src/lib/api.ts`)
  - 在 `Task` 接口中添加 `max_recordings: number` 字段

- **创建任务表单** (`web/src/pages/Tasks.tsx`)
  - 添加"录制段数"输入框
  - 支持设置 0（无限制）或具体数值
  - 输入框提示："0=无限制"
  - 表单布局改为 3 列（间隔时长、录制时长、录制段数）

- **任务列表显示**
  - 显示录制段数信息（0 显示为 ∞）
  - 中文化标签（间隔、时长、段数、AI 开启/关闭）

### 2. 视频切片逻辑调整

#### 当前配置
- **切片间隔**：每 30 秒提取一帧（用户已修改）
- **提取位置**：`server/scheduler.py` 第 99 行
- **代码**：
  ```python
  frames = await MediaProcessor.extract_frames(save_path, frames_dir, interval=30)
  ```

#### 切片数量计算
- **公式**：`帧数 = 录制时长 / 切片间隔`
- **示例**：
  - 60秒视频，30秒间隔 → 约 2 帧
  - 120秒视频，30秒间隔 → 约 4 帧
  - 300秒视频，30秒间隔 → 约 10 帧

#### 用途
- 第一帧用作封面图 (`record.cover_path`)
- 所有帧用于 AI 视觉分析（最多取前 10 帧）

## 使用说明

### 创建带录制段数限制的任务

1. 点击 "New Task" 按钮
2. 填写必填信息：
   - Live URL
   - 主播ID
   - 主播名称（可选）
3. 设置录制参数：
   - **间隔时长**：两次录制之间的间隔（秒）
   - **录制时长**：每次录制的时长（秒）
   - **录制段数**：
     - `0` = 无限制，任务会一直运行直到手动停止
     - `1` = 录制 1 段后自动停止
     - `5` = 录制 5 段后自动停止
     - 以此类推
4. 启用/禁用 AI 分析
5. 点击 "Create" 创建任务

### 示例场景

#### 场景 1：定时监控
- 间隔时长：300 秒（5分钟）
- 录制时长：60 秒
- 录制段数：12
- **结果**：每 5 分钟录制 1 段 60 秒视频，录制 12 段后自动停止（总时长约 1 小时）

#### 场景 2：连续录制
- 间隔时长：60 秒
- 录制时长：60 秒
- 录制段数：0
- **结果**：连续录制，每分钟一段，直到手动停止

#### 场景 3：单次录制
- 间隔时长：300 秒
- 录制时长：120 秒
- 录制段数：1
- **结果**：录制 1 段 120 秒视频后自动停止

## 技术细节

### 自动停止逻辑
```python
# 检查是否达到最大录制段数
if task.max_recordings > 0:
    # 统计该任务已完成的录制数量
    completed_count = session.exec(
        select(Record).where(
            Record.task_id == task_id,
            Record.status.in_(['recorded', 'analyzed'])
        )
    ).all()
    
    if len(completed_count) >= task.max_recordings:
        # 停止任务
        task.is_active = False
        remove_task_job(task_id)
```

### 注意事项
1. 只有状态为 `recorded` 或 `analyzed` 的记录才会被计入完成数量
2. 状态为 `failed` 或 `recording` 的记录不计入
3. 任务自动停止后，可以通过"恢复"按钮重新启动
4. 重新启动后，会继续累计录制数量

## 测试建议

1. **测试无限制录制**：
   - 创建任务，录制段数设为 0
   - 验证任务持续运行
   - 手动暂停/停止

2. **测试限制录制**：
   - 创建任务，录制段数设为 2
   - 等待录制 2 段
   - 验证任务自动停止

3. **测试视频切片**：
   - 创建任务，录制时长 120 秒
   - 检查生成的帧数（应该约为 4 帧）
   - 验证封面图正确设置
